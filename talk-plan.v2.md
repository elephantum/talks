# Apache Iceberg изнутри: Глубокое погружение (Bottom-Up)

## План доклада (30 минут)

### 1. Введение (3 мин)
- **Проблема**: Почему Hive-таблицы не справились на масштабе (листинг директорий, переименование файлов, отсутствие атомарности).
- **Решение**: Iceberg как **Табличный Формат**, а не файловый формат.
- **Ключевая идея**: Отслеживание файлов, а не директорий.

### 2. Анатомия Iceberg-таблицы: От файлов к таблице (7 мин)
*Строим таблицу снизу вверх, слой за слоем.*

- **Слой 1: Data & Delete Files**:
    - Обычные Parquet/ORC файлы с данными.
    - Файлы удалений (Delete Files) для поддержки обновлений (Merge-On-Read) без перезаписи гигабайтов данных.
- **Слой 2: Manifest Files**:
    - Проблема: Как знать, какие файлы принадлежат таблице?
    - Решение: Файл-список (Manifest). Хранит пути к файлам и статистику (min/max, null counts) для каждого файла.
- **Слой 3: Manifest List (Snapshot)**:
    - Проблема: Манифестов становится слишком много.
    - Решение: Список манифестов. Формирует **Снапшот** — конкретное состояние данных в момент времени.
- **Слой 4: Metadata File (`v1.metadata.json`)**:
    - Проблема: Как хранить историю изменений и схему?
    - Решение: "Мозг" таблицы. Хранит список всех снапшотов, историю схем и партиционирования.
- **Слой 5: Catalog**:
    - Проблема: Где найти актуальный файл метаданных?
    - Решение: Атомарный указатель (CAS) на текущий `metadata.json`.

### 3. Глубокое погружение: Путь чтения (8 мин)
*Используем построенную структуру для быстрого поиска.*

- **Snapshot Isolation**: Старт от Каталога к конкретному Снапшоту.
- **Иерархия отсечения (Pruning)**:
    1. **Partition Pruning**: Использование Manifest List для отсечения групп файлов.
    2. **Min/Max фильтрация**: Использование Manifest File для отсечения конкретных файлов.
- **Scan Planning**: Превращение метаданных в список задач на чтение без листинга S3.

### 4. Глубокое погружение: Путь записи и ACID (7 мин)
*Запись повторяет структуру снизу вверх.*

- **Optimistic Concurrency Control (OCC)**.
- **Процесс коммита**:
    1. **Write Data**: Запись файлов данных (невидимы для читателей).
    2. **Write Manifests**: Создание индексов для новых файлов.
    3. **Write Metadata**: Создание новой версии таблицы (новый снапшот).
    4. **Commit**: Атомарная подмена указателя в Каталоге.
- **Разрешение конфликтов**: Проверка совместимости операций при конкурентной записи.

### 5. Продвинутые возможности (5 мин)
- **Скрытое партиционирование**: Партиционирование как функция от данных, а не физическая структура папок.
- **Эволюция схемы**: Использование уникальных ID колонок для безопасных изменений схемы.
- **Time Travel**: Использование истории снапшотов из Metadata File.
- **Обслуживание**: Компактификация (пересборка Data Files) и удаление старых снапшотов.

### 6. Бонус: Интерактивная демонстрация с PyIceberg (5 мин)
- **Настройка**: Локальный filesystem catalog + DuckDB.
- **Пошаговый разбор**:
    1. **Init**: Создание таблицы `taxi_dataset` и осмотр структуры.
    2. **Append**: Добавление данных, появление нового снапшота.
    3. **Time Travel**: Чтение старой версии.
    4. **Pruning**: Демонстрация отсечения файлов.
- **Цель**: Показать, как абстракции маппятся на реальные файлы.
