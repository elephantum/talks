# Apache Iceberg изнутри: Глубокое погружение

## План доклада (30 минут)

### 1. Введение (3 мин)
- **Проблема**: Почему Hive-таблицы не справились на масштабе (листинг директорий, переименование файлов, отсутствие атомарности).
- **Решение**: Iceberg как **Табличный Формат**, а не файловый формат.
- **Ключевая идея**: Отслеживание файлов, а не директорий.

### 2. Анатомия Iceberg-таблицы (7 мин)
- **Древовидная структура**: От каталога до данных.
- **Catalog**: Указатель на текущее состояние.
- **Metadata File (`v1.metadata.json`)**: Состояние таблицы (схема, спецификация партиционирования, снапшоты).
- **Manifest List**: Список манифестов, составляющих снапшот.
- **Manifest File**: Список файлов данных со статистикой и информацией о партициях.
- **Data Files**: Parquet/ORC/Avro файлы с фактическими данными.

### 3. Глубокое погружение: Путь чтения (8 мин)
- **Snapshot Isolation**: Как читатели выбирают конкретную версию.
- **Иерархия отсечения (Pruning)**:
    1. **Partition Pruning**: Использование Manifest Lists для пропуска целых групп файлов.
    2. **Min/Max фильтрация**: Использование Manifest Files для пропуска отдельных файлов на основе статистики колонок.
- **Планирование сканирования**: Почему это быстро (операции только с метаданными).

### 4. Глубокое погружение: Путь записи и ACID (7 мин)
- **Optimistic Concurrency Control (OCC)**.
- **Процесс коммита**:
    1. Запись файлов данных.
    2. Запись новых манифестов.
    3. Запись нового Metadata File.
    4. Атомарная подмена (CAS) в каталоге.
- **Разрешение конфликтов**: Обработка конкурентных записей.

### 5. Продвинутые возможности (5 мин)
- **Скрытое партиционирование**: Больше никаких колонок `date_str`; партиционирование — это конфигурация, а не схема.
- **Эволюция схемы**: Отслеживание колонок по ID (безопасные переименования, добавления, удаления, перестановки).
- **Time Travel**: Запросы к историческим снапшотам.
- **Обслуживание**: Компактификация и удаление старых снапшотов.

### 6. Бонус: Интерактивная демонстрация с PyIceberg (5 мин)
- **Настройка**: Локальный filesystem catalog + DuckDB.
- **Пошаговый разбор**:
    1. Создание таблицы и осмотр структуры директорий (metadata vs data).
    2. Выполнение `append` и наблюдение за новым снапшотом.
    3. Выполнение `merge` (COW/MOR) и изучение изменений в манифестах.
    4. Time travel к первому снапшоту.
- **Цель**: Показать, а не рассказать, как растёт дерево метаданных.
